# claude-tower 機能仕様書

## 1. 概要

### 1.1 プロジェクト名
claude-tower

### 1.2 目的
Claude Code セッションを効率的に管理するための tmux プラグイン。階層的なツリー表示、ライブプレビュー、Git ワークツリー統合により、複数のプロジェクトを並行して開発する環境を提供する。

### 1.3 対象ユーザー
- Claude Code CLI を使用する開発者
- tmux をターミナルマルチプレクサとして使用するユーザー
- 複数のプロジェクトを同時に管理したいユーザー

---

## 2. 機能一覧

### 2.1 セッション管理

| 機能 | 説明 |
|------|------|
| セッション作成 | 新規 tmux セッションを作成し、Claude Code を起動 |
| セッション切り替え | ツリービューから選択してセッションを切り替え |
| セッション名変更 | 既存セッションの名前を変更 |
| セッション削除 | セッションを終了し、関連リソースをクリーンアップ |

### 2.2 セッションタイプ

#### 2.2.1 ワークスペースセッション [W]
- **対象**: Git リポジトリ内のディレクトリ
- **特徴**:
  - Git ワークツリーによる分離環境を自動作成
  - `tower/<セッション名>` ブランチを自動作成
  - ソースコミットからの差分表示機能
  - セッション終了時にワークツリーを自動削除
- **保存先**: `~/.claude-tower/worktrees/<セッション名>`

#### 2.2.2 シンプルセッション [S]
- **対象**: 非 Git ディレクトリ
- **特徴**:
  - 通常の tmux セッション
  - Git 統合なし
  - 軽量な動作

### 2.3 ツリービュー表示

階層構造でセッション・ウィンドウ・ペインを表示:

```
📁 ● [W] project-api  ⎇ tower/feature-auth +5,-2
  ├─ 🪟 0: main ●
  │  └─ ▫ 0: claude ●
  └─ 🪟 1: shell
     └─ ▫ 0: zsh
📁 [S] scripts  (no git)
  └─ 🪟 0: main
     └─ ▫ 0: claude
```

**アイコン凡例**:
| アイコン | 意味 |
|----------|------|
| 📁 | セッション |
| 🪟 | ウィンドウ |
| ▫ | ペイン |
| ● | アクティブ（現在選択中） |
| ⎇ | Git ブランチ |
| [W] | ワークスペースセッション |
| [S] | シンプルセッション |

### 2.4 ライブプレビュー

選択中のアイテムについて、以下の情報をリアルタイム表示:

- **セッション**: 概要、Git ステータス、ペイン内容
- **ウィンドウ**: レイアウト、ペイン内容
- **ペイン**: 実行コマンド、パス、PID、ターミナル内容（直近30行）

### 2.5 Git 差分表示

ワークスペースセッションで利用可能:
- ソースコミットとの差分を表示
- ファイルごとの追加・削除行数を統計表示
- カラー付き差分出力

### 2.6 孤立ワークツリーのクリーンアップ

異常終了（クラッシュ、kill -9 等）時に残った孤立ワークツリーを管理:
- 孤立ワークツリーの一覧表示
- 対話的クリーンアップ
- 強制クリーンアップ

---

## 3. ユーザーインターフェース

### 3.1 キーバインド

#### 3.1.1 プライマリキーバインド

| キー | アクション |
|------|------------|
| `prefix + C` | セッションピッカーを開く |
| `prefix + T` | 新規セッションを作成 |

#### 3.1.2 ピッカー内操作

| キー | アクション | 対象 |
|------|------------|------|
| `Enter` | 選択アイテムに切り替え | セッション/ウィンドウ/ペイン |
| `n` | 新規セッション作成 | - |
| `r` | 名前変更 | セッション/ウィンドウ |
| `x` | 削除 | セッション/ウィンドウ/ペイン |
| `D` | Git 差分表示 | ワークスペースセッションのみ |
| `?` | ヘルプ表示 | - |
| `Esc` | ピッカーを閉じる | - |
| `j` / `↓` | 下に移動 | ナビゲーション |
| `k` / `↑` | 上に移動 | ナビゲーション |
| `/` | 検索 | ピッカー内 |
| `Tab` | プレビュー切り替え | プレビューペイン |

### 3.2 fzf ピッカー UI

- ファジー検索による高速フィルタリング
- リアルタイムプレビューパネル
- カラー付きツリー表示
- 操作後の自動リロード

---

## 4. 設定オプション

### 4.1 tmux 設定（~/.tmux.conf）

```bash
# ピッカーキーのカスタマイズ（デフォルト: C）
set -g @tower-key 'C'

# 新規セッションキーのカスタマイズ（デフォルト: T）
set -g @tower-new-key 'T'
```

### 4.2 環境変数

| 変数名 | 説明 | デフォルト値 |
|--------|------|--------------|
| `CLAUDE_TOWER_PROGRAM` | セッションで実行するプログラム | `claude` |
| `CLAUDE_TOWER_WORKTREE_DIR` | ワークツリーの保存ディレクトリ | `~/.claude-tower/worktrees` |
| `CLAUDE_TOWER_METADATA_DIR` | メタデータの保存ディレクトリ | `~/.claude-tower/metadata` |

---

## 5. データ構造

### 5.1 メタデータファイル

**保存場所**: `~/.claude-tower/metadata/tower_<セッション名>.meta`

**フォーマット**:
```
session_id=tower_example
session_type=workspace|simple
created_at=2025-01-01T00:00:00+00:00
repository_path=/path/to/repo
source_commit=abc123def456
worktree_path=/home/user/.claude-tower/worktrees/example
```

**フィールド説明**:
| フィールド | 説明 |
|------------|------|
| `session_id` | セッション識別子（`tower_` プレフィックス付き） |
| `session_type` | セッションタイプ（`workspace` または `simple`） |
| `created_at` | 作成日時（ISO 8601 形式） |
| `repository_path` | 元の Git リポジトリパス |
| `source_commit` | ワークツリー作成元のコミット |
| `worktree_path` | ワークツリーのパス |

### 5.2 ワークツリー

**保存場所**: `~/.claude-tower/worktrees/<セッション名>`

**ブランチ命名規則**: `tower/<セッション名>`

---

## 6. セキュリティ機能

### 6.1 入力サニタイズ

- **許可文字**: 英数字、ハイフン、アンダースコアのみ
- **最大長**: 64文字
- **除去対象**: シェルメタ文字（`;`、`$()`、バッククォート等）
- **トリム**: 先頭・末尾の特殊文字を除去

### 6.2 パス検証

- ディレクトリトラバーサル攻撃の防止（例: `../../etc/passwd`）
- シンボリックリンクエスケープの防止
- `realpath` による正規化検証
- ワークツリーパスが `~/.claude-tower/worktrees` 内に収まることを検証

### 6.3 コマンドインジェクション防止

- シェルメタ文字の除去
- git/tmux コマンドへの安全なパラメータ渡し

### 6.4 セッション分離

- 各ワークスペースセッションは独立した Git ワークツリーで動作
- ブランチ分離により意図しない競合を防止
- 別々のメタデータファイルによる相互汚染防止

---

## 7. スクリプト構成

### 7.1 ファイル構成

```
tmux-plugin/
├── claude-tower.tmux          # エントリポイント（キーバインド設定）
├── lib/
│   └── common.sh              # 共通ライブラリ
└── scripts/
    ├── tower.sh               # メインセッションピッカー
    ├── new-session.sh         # セッション作成
    ├── rename.sh              # 名前変更
    ├── kill.sh                # 削除
    ├── preview.sh             # プレビュー生成
    ├── diff.sh                # Git 差分表示
    ├── help.sh                # ヘルプ表示
    └── cleanup.sh             # 孤立ワークツリークリーンアップ
```

### 7.2 各スクリプトの責務

| スクリプト | 責務 |
|------------|------|
| `claude-tower.tmux` | プラグイン初期化、キーバインド登録 |
| `common.sh` | 共通関数（サニタイズ、メタデータ、エラー処理） |
| `tower.sh` | ツリービュー構築、選択処理、fzf 統合 |
| `new-session.sh` | セッション作成フロー、ワークツリー生成 |
| `rename.sh` | セッション/ウィンドウ名変更 |
| `kill.sh` | セッション/ウィンドウ/ペイン削除、クリーンアップ |
| `preview.sh` | ライブプレビュー生成 |
| `diff.sh` | Git 差分表示 |
| `help.sh` | ヘルプ情報表示 |
| `cleanup.sh` | 孤立ワークツリー管理 |

---

## 8. セッションライフサイクル

### 8.1 ワークスペースセッション作成フロー

```
1. ユーザーが prefix + T を押下、または ピッカーで n を選択
2. セッション名の入力を促す
3. カレントディレクトリが Git リポジトリか検出
4. 入力をサニタイズしてセッション ID を生成（tower_*）
5. ~/.claude-tower/worktrees/<名前> にワークツリーを作成
6. tower/<名前> ブランチを現在のコミットから作成
7. ワークツリーディレクトリに tmux セッションを作成
8. メタデータファイルを保存
9. 新規セッションに切り替え、Claude を起動
```

### 8.2 セッション切り替えフロー

```
1. ユーザーが prefix + C を押下してピッカーを開く
2. ツリービューに全セッション/ウィンドウ/ペインを表示
3. プレビューパネルに選択中アイテムの内容を表示
4. ユーザーがアイテムを選択して Enter を押下
5. 選択先に tmux クライアントを切り替え
```

### 8.3 セッション削除フロー

```
1. ユーザーがピッカーでセッションを選択し x を押下
2. 確認ダイアログを表示
3. ワークスペースセッションの場合: Git ワークツリーを削除
4. tmux セッションを kill
5. メタデータファイルを削除
6. 完了メッセージを表示
```

### 8.4 孤立ワークツリークリーンアップフロー

```
1. メタデータに存在するが tmux に存在しないセッションを検出
2. git worktree remove でワークツリーを削除
3. 通常削除が失敗した場合 --force でフォールバック
4. Git リポジトリが利用不可な場合はディレクトリを直接削除
5. メタデータファイルをクリーンアップ
```

---

## 9. 依存関係

### 9.1 必須

| ソフトウェア | バージョン | 用途 |
|--------------|------------|------|
| tmux | 3.0+ | セッション管理 |
| fzf | - | ピッカー UI |
| git | - | ワークスペースモード |
| Claude Code CLI | - | セッションで実行するプログラム |
| bash | 4.0+ | スクリプト実行 |

### 9.2 オプション

| ソフトウェア | 用途 |
|--------------|------|
| bats-core | テストスイート実行 |
| realpath | パス検証（通常 coreutils に含まれる） |

---

## 10. インストール

### 10.1 TPM（Tmux Plugin Manager）経由

```bash
# ~/.tmux.conf に追加
set -g @plugin 'tapoh22334/claude-tower'

# prefix + I でインストール
```

### 10.2 手動インストール

```bash
git clone https://github.com/tapoh22334/claude-tower ~/.tmux/plugins/claude-tower

# ~/.tmux.conf に追加
run-shell ~/.tmux/plugins/claude-tower/tmux-plugin/claude-tower.tmux

# 設定を再読み込み
tmux source ~/.tmux.conf
```

### 10.3 インストール確認

```bash
tmux list-keys | grep tower
```

---

## 11. テスト

### 11.1 テストフレームワーク

BATS（Bash Automated Testing System）を使用。

### 11.2 テストファイル構成

| ファイル | テスト対象 | テスト数 |
|----------|------------|----------|
| `test_sanitize.bats` | 入力サニタイズ | 20 |
| `test_metadata.bats` | メタデータ永続化 | 13 |
| `test_orphan.bats` | 孤立ワークツリー管理 | 11 |

### 11.3 テスト実行

```bash
cd tests
./run_tests.sh           # 全テスト実行
./run_tests.sh sanitize  # 特定テストのみ実行
./run_tests.sh --verbose # 詳細出力
```

---

## 12. 用語集

| 用語 | 定義 |
|------|------|
| セッション | 複数のウィンドウを持つ tmux の作業単位 |
| ウィンドウ | セッション内のビュー、複数のペインを持つ |
| ペイン | ウィンドウ内の分割領域 |
| セッション ID | `tower_` プレフィックスを持つ識別子 |
| ワークスペースセッション | Git ワークツリーで分離されたセッション |
| シンプルセッション | Git 統合なしの通常セッション |
| ワークツリー | 独立した Git 作業ディレクトリ |
| ソースコミット | ワークツリー作成元のコミット |
| 孤立ワークツリー | アクティブな tmux セッションを持たないワークツリー |
| メタデータ | 永続化されたセッション情報 |

---

## 13. バージョン履歴

| コミット | 概要 |
|----------|------|
| f3c03d7 | BATS テストフレームワークによるユニットテスト追加 |
| 8ebb566 | ユビキタス言語の一貫性のための用語リファクタリング |
| d79dd68 | プロジェクト名を claude-pilot から claude-tower に変更 |
| 2774385 | セキュリティ修正、共通ライブラリ、メタデータ永続化の追加 |
| 57c7b3f | 初期コミット - Claude Code セッション管理用 tmux プラグイン |

---

## 14. ライセンス

MIT License (Copyright 2024 claude-tower contributors)
